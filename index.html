<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acc√®s Planning ‚Äî RH / Employ√©</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="force-dark">
  <div class="wrap">
    <div class="card" id="screen-home">
      <h1>Acc√®s au planning</h1>
      <p class="lead">Connexion √† la base de donn√©es en direct.</p>

      <div class="choices">
        <button class="btn" id="btn-rh">Je suis RH</button>
        <button class="btn secondary" id="btn-emp">Je suis un¬∑e employ√©¬∑e</button>
      </div>

      <div id="form-rh" class="panel hidden fade-in">
        <div class="input-row">
          <input type="password" id="rh-code" placeholder="Code RH (Essaye: RH2025)" />
          <button class="btn" id="rh-validate">Valider</button>
        </div>
        <p class="small">Le code par d√©faut est <strong>RH2025</strong>.</p>
      </div>

      <div id="form-emp" class="panel hidden fade-in">
        <div class="input-row">
          <input type="text" id="emp-name" placeholder="Pr√©nom (ex. Alice)" autocomplete="name" />
          <button class="btn" id="emp-open">Entrer</button>
        </div>
        <p class="small">Saisis ton pr√©nom pour ouvrir ta page personnelle.</p>
      </div>
    </div>

    <div class="card hidden" id="screen-rh">
      <div class="topbar">
        <h1>Tableau de bord RH</h1>
        <div>
          <button class="btn secondary" id="btn-rh-back">D√©connexion</button>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <strong>Rechercher un¬∑e employ√©¬∑e</strong>
          <div class="input-row" style="margin-top:8px">
            <input type="text" id="rh-search-name" placeholder="Pr√©nom (ex: Alice)" />
            <button class="btn" id="rh-search">Voir disponibilit√©s</button>
          </div>
          <p class="small">Appuie sur Entr√©e pour valider.</p>
        </div>

        <div class="panel">
          <strong>Actions RH</strong>
          <div style="margin-top:8px">
              <label for="pdf-upload-input" class="small" style="margin-bottom:4px; display:block;">Ajouter un nouveau contrat :</label>
              <input type="file" id="pdf-upload-input" accept=".pdf" style="font-size: 0.85rem;">
              <button class="btn" id="pdf-upload-btn" style="margin-top:8px;">Envoyer PDF</button>
              <p class="small hidden" id="upload-status" style="margin-top:8px;"></p>
          </div>
          <hr style="border:0; border-top:1px solid var(--accent-border); margin: 14px 0;">
          <div class="choices">
              <button class="btn secondary" id="dl-csv">T√©l√©charger CSV</button>
          </div>
        </div>
      </div>

      <div id="rh-result" class="panel hidden" style="margin-top:14px">
        <h2 style="margin:0 0 10px 0">Disponibilit√©s de <span id="rh-emp-label" style="color:var(--accent)"></span></h2>
        <table id="rh-table">
          <thead>
            <tr><th>Jour</th><th>Plage de pr√©sence</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="rh-proposal" class="panel hidden" style="margin-top:14px; border-color:var(--success); background-color: #1a2a1f;">
        <h2 style="margin:0 0 10px 0; color:var(--success);">‚úÖ Proposition de planning g√©n√©r√©e</h2>
        <p class="small" id="proposal-message">L'employ√© a √©t√© ajout√©. Voici une proposition de planning pour ses t√¢ches. Vous pouvez l'approuver ou l'ignorer.</p>
        
        <table id="proposal-table" style="background: var(--card); border-radius: 8px;">
          <thead>
            <tr><th>Date</th><th>T√¢che (ID)</th><th>Plage</th></tr>
          </thead>
          <tbody>
            </tbody>
        </table>
        
        <button class="btn" id="btn-approve-plan" style="margin-top:12px; background-color: var(--success);">Approuver et appliquer ce plan</button>
        <p class="small hidden" id="approve-status" style="margin-top:8px;"></p>
      </div>

    </div>

    <div class="card hidden" id="screen-emp">
      <div class="topbar">
        <h1>Mon planning</h1>
        <button class="btn secondary" id="emp-back">Quitter</button>
      </div>

      <div class="grid">
        <div class="panel">
          <div><strong>Pr√©nom :</strong> <span id="emp-firstname"></span></div>
          <div><strong>Poste :</strong> <span id="emp-role"></span></div>
        </div>
      </div>

      <h2 style="margin-top:14px">Mes t√¢ches planifi√©es</h2>
      <table id="emp-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>T√¢che</th>
            <th>Horaires</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
      <p class="small hidden" id="emp-no-tasks">Aucune t√¢che n'est planifi√©e pour toi pour l'instant.</p>
    </div>
    </div>

  <button id="chat-toggle" class="fab-chat hidden" title="Ouvrir le chat">üí¨</button>
  <div id="chat-widget" class="chat chat-closed">
    <div class="chat-header">
      <div>
        <strong id="chat-title">Assistant</strong>
        <div class="small" id="chat-subtitle">Support planning</div>
      </div>
      <button id="chat-close" class="link-like">‚úï</button>
    </div>
    <div id="chat-body" class="chat-body"></div>
    <form id="chat-form" class="chat-input" autocomplete="off">
      <input id="chat-text" type="text" placeholder="√âcrire un message‚Ä¶" />
      <button class="btn" type="submit">Envoyer</button>
    </form>
  </div>

  <script>
    (async function () {
      // =========================================
      // 1. CONFIGURATION
      // =========================================
      const API_PLANNING_URL = "http://localhost:5000/api/planning";
      const API_SCHEDULE_URL = "http://localhost:5000/api/my-schedule";
      const API_UPLOAD_URL = "http://localhost:5000/api/upload-contract";
      const API_APPROVE_URL = "http://localhost:5000/api/approve-plan";
      const API_CHAT_URL = "http://localhost:5000/api/chat"; // URL du chat
      const RH_CODE = "RH2025";
      const DAYS_ORDER = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];
      
      const DAYS_MAP = {
        'Mon': 'Lun', 'Tue': 'Mar', 'Wed': 'Mer', 'Thu': 'Jeu', 
        'Fri': 'Ven', 'Sat': 'Sam', 'Sun': 'Dim'
      };

      let employeesData = [];
      let index = {};
      const norm = (v) => (v || "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      // =========================================
      // 2. CHARGEMENT DES DONN√âES (POUR LA VUE RH)
      // =========================================
      async function loadData() {
        try {
          const response = await fetch(API_PLANNING_URL);
          if (!response.ok) {
            const errorBody = await response.text();
            throw new Error(`Erreur connexion serveur: ${response.status} ${errorBody}`);
          }
          const rawData = await response.json();
          if (rawData.error) throw new Error(`Erreur serveur: ${rawData.error}`);

          const tempMap = {};
          rawData.forEach(row => {
              const fullName = row.first_name;
              if (!tempMap[fullName]) {
                  tempMap[fullName] = {
                      name: fullName,
                      role: row.role || "Employ√©",
                      week: {}
                  };
              }
              if (row.day) {
                const dayFr = DAYS_MAP[row.day] || row.day;
                const start = row.start ? row.start.substring(0, 5) : "";
                const end = row.end ? row.end.substring(0, 5) : "";
                tempMap[fullName].week[dayFr] = `${start}‚Äì${end}`;
              }
          });

          employeesData = Object.values(tempMap);
          index = {};
          employeesData.forEach(e => { index[norm(e.name)] = e; });
          console.log("‚úÖ Donn√©es (disponibilit√©s) charg√©es depuis la DB :", employeesData);
          return true;

        } catch (error) {
          console.error("Erreur API:", error);
          alert("Impossible de connecter au serveur (server.py). V√©rifie qu'il est lanc√© !");
          employeesData = [];
          return false;
        }
      }
      
      const loaded = await loadData();
      
      // =========================================
      // 3. UTILITAIRES UI & NAVIGATION
      // =========================================
      const $ = (sel) => document.querySelector(sel);
      const show = (id) => document.getElementById(id).classList.remove("hidden");
      const hide = (id) => document.getElementById(id).classList.add("hidden");

      // Fonction pour la table des DISPONIBILIT√âS (RH)
      function fillDispoTable(tbody, week) {
        tbody.innerHTML = "";
        DAYS_ORDER.forEach((d) => {
          const tr = document.createElement("tr");
          const td1 = document.createElement("td");
          const td2 = document.createElement("td");
          td1.textContent = d;
          td2.textContent = week[d] || "‚Äî";
          if(!week[d]) td2.style.color = "var(--muted)";
          tr.append(td1, td2);
          tbody.appendChild(tr);
        });
      }

      if (!loaded) {
          hide("form-rh");
          hide("form-emp");
      }
      
      $("#btn-rh").onclick = () => { if(loaded) { show("form-rh"); hide("form-emp"); $("#rh-code").focus(); }};
      $("#btn-emp").onclick = () => { if(loaded) { show("form-emp"); hide("form-rh"); $("#emp-name").focus(); }};

      // --- LOGIN RH ---
      let currentRole = null;
      function loginRH() {
        if ($("#rh-code").value.trim() === RH_CODE) {
          $("#rh-code").value = "";
          hide("screen-home"); show("screen-rh");
          currentRole = "rh"; // On d√©finit le r√¥le
          updateChatRole(); show("chat-toggle");
        } else { alert("Code incorrect (RH2025)"); }
      }
      $("#rh-validate").onclick = loginRH;
      $("#rh-code").addEventListener("keyup", (e) => { if (e.key === "Enter") loginRH(); });

      // --- ACTIONS RH ---
      $("#btn-rh-back").onclick = () => {
        hide("screen-rh"); show("screen-home"); currentRole = null; hide("chat-toggle"); hide("rh-result"); $("#rh-search-name").value="";
      };
      
      function searchEmployee() {
        const query = $("#rh-search-name").value;
        const emp = index[norm(query)];
        const tbody = document.querySelector("#rh-table tbody");
        if (emp) {
          $("#rh-emp-label").textContent = emp.name + " (" + emp.role + ")";
          fillDispoTable(tbody, emp.week); // La RH voit les DISPOS
          show("rh-result");
        } else { alert("Employ√© introuvable."); }
      }
      $("#rh-search").onclick = searchEmployee;
      $("#rh-search-name").addEventListener("keyup", (e) => { if (e.key === "Enter") searchEmployee(); });

      $("#dl-csv").onclick = () => {
        // ... (code dl-csv inchang√©) ...
      };

      // --- BLOC D'UPLOAD (inchang√©) ---
      const uploadInput = $("#pdf-upload-input");
      const uploadBtn = $("#pdf-upload-btn");
      const uploadStatus = $("#upload-status");
      const proposalPanel = $("#rh-proposal");
      const proposalMsg = $("#proposal-message");
      const proposalTableBody = document.querySelector("#proposal-table tbody");
      const approveBtn = $("#btn-approve-plan");
      const approveStatus = $("#approve-status");

      let currentProposal = null;
      
      uploadBtn.onclick = async () => {
          const file = uploadInput.files[0];
          if (!file || file.type !== "application/pdf") {
              alert("Veuillez s√©lectionner un fichier PDF."); return;
          }
          
          const formData = new FormData();
          formData.append("file", file);

          uploadStatus.textContent = "T√©l√©chargement et analyse IA en cours... (peut prendre 30 sec)";
          uploadStatus.classList.remove("hidden");
          uploadStatus.style.color = "var(--muted)";
          proposalPanel.classList.add("hidden");
          approveStatus.classList.add("hidden");
          uploadBtn.disabled = true;

          try {
              const response = await fetch(API_UPLOAD_URL, { method: "POST", body: formData });
              const result = await response.json();
              if (!response.ok) throw new Error(result.error || "Erreur inconnue");
              
              uploadStatus.textContent = result.message;
              uploadInput.value = "";
              
              await loadData(); // Recharger les donn√©es pour que la recherche RH fonctionne

              if (result.plan_proposal && result.plan_proposal.plan.length > 0) {
                  currentProposal = result.plan_proposal;
                  proposalTableBody.innerHTML = "";
                  
                  result.plan_proposal.plan.forEach(item => {
                      const tr = document.createElement("tr");
                      tr.innerHTML = `
                          <td>${item.date}</td>
                          <td>T√¢che #${item.task_id}</td>
                          <td>${item.start_time} - ${item.end_time}</td>
                      `;
                      proposalTableBody.appendChild(tr);
                  });
                  
                  proposalMsg.textContent = result.message;
                  proposalPanel.classList.remove("hidden");
                  approveStatus.textContent = "";
                  approveStatus.classList.add("hidden");
                  uploadStatus.style.color = "var(--success)";
              } else if (result.report && result.report.errors.length > 0) {
                   uploadStatus.textContent = `Employ√© ajout√©, mais le plan a √©chou√©: ${result.report.errors[0]}`;
                   uploadStatus.style.color = "var(--danger)";
              } else {
                   uploadStatus.textContent = "Employ√© ajout√©. Aucune t√¢che n'a pu √™tre planifi√©e (v√©rifiez les t√¢ches 'Pending').";
                   uploadStatus.style.color = "var(--muted)";
              }
              
          } catch (error) {
              uploadStatus.textContent = `Erreur: ${error.message}`;
              uploadStatus.style.color = "var(--danger)";
          } finally {
              uploadBtn.disabled = false;
          }
      };

      // --- APPROBATION (inchang√©) ---
      approveBtn.onclick = async () => {
          if (!currentProposal) return;
          
          approveStatus.textContent = "Application en cours...";
          approveStatus.classList.remove("hidden");
          approveStatus.style.color = "var(--muted)";
          approveBtn.disabled = true;
          
          try {
              const response = await fetch(API_APPROVE_URL, {
                  method: "POST",
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(currentProposal)
              });
              
              const result = await response.json();
              if (!response.ok) throw new Error(result.error);
              
              approveStatus.textContent = result.message;
              approveStatus.style.color = "var(--success)";
              currentProposal = null;
              setTimeout(() => { proposalPanel.classList.add("hidden"); }, 2000);

          } catch (error) {
              approveStatus.textContent = `Erreur: ${error.message}`;
              approveStatus.style.color = "var(--danger)";
          } finally {
              approveBtn.disabled = false;
          }
      };

      // --- LOGIN EMP (inchang√©) ---
      let currentEmployee = null;

      function fillScheduleTable(tbody, schedule) {
          tbody.innerHTML = "";
          
          const noTasksEl = $("#emp-no-tasks");
          if (schedule.length === 0) {
              show("emp-no-tasks");
              return;
          }
          
          hide("emp-no-tasks");
          schedule.forEach(item => {
              const tr = document.createElement("tr");
              const td1 = document.createElement("td");
              const td2 = document.createElement("td");
              const td3 = document.createElement("td");
              
              td1.textContent = item.date;
              td2.textContent = item.task;
              td3.textContent = `${item.start}‚Äì${item.end}`;
              
              tr.append(td1, td2, td3);
              tbody.appendChild(tr);
          });
      }

      async function loginEmp() {
        const name = $("#emp-name").value;
        
        const emp = index[norm(name)];
        if (!emp) { 
            alert("Pr√©nom introuvable. Es-tu s√ªr qu'il est dans la base de donn√©es ?"); 
            return; 
        }
        
        currentEmployee = emp; // Stocke l'objet employ√©
        $("#emp-firstname").textContent = emp.name;
        $("#emp-role").textContent = emp.role;
        
        try {
            const response = await fetch(`${API_SCHEDULE_URL}?name=${encodeURIComponent(emp.name)}`);
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Erreur lors de la r√©cup√©ration du planning.");
            }
            
            const scheduleData = await response.json();
            fillScheduleTable(document.querySelector("#emp-table tbody"), scheduleData);
            
            $("#emp-name").value = ""; 
            hide("screen-home"); 
            show("screen-emp");
            currentRole = "emp"; // D√©finit le r√¥le
            updateChatRole(); 
            show("chat-toggle");
            
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
      }
      
      $("#emp-open").onclick = loginEmp;
      $("#emp-name").addEventListener("keyup", (e) => { if (e.key === "Enter") loginEmp(); });
      $("#emp-back").onclick = () => { hide("screen-emp"); show("screen-home"); currentRole = null; hide("chat-toggle"); };

      // --- CHAT (CORRIG√â : FONCTIONS RESTAUR√âES ET MODIFI√âES) ---
      const chatBox = $("#chat-widget");
      const chatBtn = $("#chat-toggle");
      const chatBody = $("#chat-body");
      const chatInput = $("#chat-text");
      const chatTitle = $("#chat-title");
      const chatSub = $("#chat-subtitle");
      
      chatBtn.onclick = () => { chatBox.classList.toggle("chat-closed"); if(!chatBox.classList.contains("chat-closed")) { chatInput.focus(); maybeGreet(); }};
      $("#chat-close").onclick = () => chatBox.classList.add("chat-closed");

      function updateChatRole() {
        chatBody.innerHTML = "";
        chatTitle.textContent = currentRole === "emp" ? "Assistant RH" : "Assistant Admin";
        chatSub.textContent = currentRole === "emp" ? "D√©clare une absence" : "Gestion";
      }

      function addMsg(who, text) {
        const d = document.createElement("div"); d.className = "msg " + (who==="user"?"from-user":"from-bot");
        d.innerHTML = `<div class="bubble">${text}</div>`; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight;
      }
      
      function maybeGreet() {
        if (chatBody.children.length === 0) {
            const msg = currentRole === 'emp' 
              ? `Bonjour ${currentEmployee.name} ! Tu peux me demander un cong√© (ex: 'je pose des cong√©s lundi prochain') ou d√©clarer une absence (ex: 'je suis malade demain').` 
              : "Bonjour ! Le chat RH est en cours de d√©veloppement.";
            addMsg("bot", msg);
        }
      }

      // --- MODIFICATION: G√®re les deux r√¥les (RH et Employ√©) ---
      $("#chat-form").addEventListener("submit", async (e) => {
        e.preventDefault(); 
        const text = chatInput.value.trim(); 
        if(!text) return;
        
        addMsg("user", text);
        chatInput.value = "";
        
        // On affiche une petite bulle de chargement
        addMsg("bot", "...");
        
        // On v√©rifie qui est en train de chatter
        if (currentRole === 'emp') {
            // L'employ√© est connect√© -> On appelle l'API des absences
            try {
                const response = await fetch(API_CHAT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: text,
                        // currentEmployee est garanti d'exister car currentRole == 'emp'
                        employee_name: currentEmployee.name 
                    })
                });
                
                const data = await response.json();
                
                chatBody.removeChild(chatBody.lastChild); // On supprime la bulle "..."

                if (data.error) {
                    addMsg("bot", `Erreur: ${data.error}`);
                } else {
                    addMsg("bot", data.reply); // On affiche la r√©ponse de l'IA/serveur
                }
                
            } catch (err) {
                chatBody.removeChild(chatBody.lastChild);
                addMsg("bot", "D√©sol√©, une erreur de connexion est survenue.");
                console.error(err);
            }
        } else {
            // Le RH est connect√© -> L'API n'est pas (encore) faite pour lui.
            // On renvoie une r√©ponse simul√©e pour que l'interface fonctionne.
            setTimeout(() => {
                chatBody.removeChild(chatBody.lastChild); // On supprime la bulle "..."
                addMsg("bot", "Le chat pour les RH est en cours de d√©veloppement. Pour l'instant, je ne g√®re que les absences des employ√©s.");
            }, 600);
        }
      });
      // --- FIN DE LA CORRECTION DU CHAT ---

    })();
  </script>
</body>
</html>