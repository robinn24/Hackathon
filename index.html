<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acc√®s Planning ‚Äî RH / Employ√©</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="force-dark">
  <div class="wrap">
    <div class="card" id="screen-home">
      <h1>Acc√®s au planning</h1>
      <p class="lead">Connexion √† la base de donn√©es en direct.</p>

      <div class="choices">
        <button class="btn" id="btn-rh">Je suis RH</button>
        <button class="btn secondary" id="btn-emp">Je suis un¬∑e employ√©¬∑e</button>
      </div>

      <div id="form-rh" class="panel hidden fade-in">
        <div class="input-row">
          <input type="password" id="rh-code" placeholder="Code RH (Essaye: RH2025)" />
          <button class="btn" id="rh-validate">Valider</button>
        </div>
        <p class="small">Le code par d√©faut est <strong>RH2025</strong>.</p>
      </div>

      <div id="form-emp" class="panel hidden fade-in">
        <div class="input-row">
          <input type="text" id="emp-name" placeholder="Pr√©nom (ex. Alice)" autocomplete="name" />
          <button class="btn" id="emp-open">Entrer</button>
        </div>
        <p class="small">Saisis ton pr√©nom pour ouvrir ta page personnelle.</p>
      </div>
    </div>

    <div class="card hidden" id="screen-rh">
      <div class="topbar">
        <h1>Tableau de bord RH</h1>
        <div>
          <button class="btn secondary" id="btn-rh-back">D√©connexion</button>
        </div>
      </div>

      <div id="rh-absences-panel" class="panel" style="border-color: var(--danger); background-color: #2a1919;">
        <h2 style="margin:0 0 10px 0; color:var(--danger);">Demandes d'absence en attente</h2>
        <table id="absences-table" style="background: var(--card); border-radius: 8px;">
          <thead>
            <tr><th>Employ√©</th><th>Dates</th><th>Motif</th><th>Actions</th></tr>
          </thead>
          <tbody id="absences-table-body"></tbody>
        </table>
        <p class="small hidden" id="absences-none">Aucune demande d'absence en attente.</p>
      </div>
      <div class="grid" style="margin-top: 14px;">
        <div class="panel">
          <strong>Rechercher un¬∑e employ√©¬∑e</strong>
          <div class="input-row" style="margin-top:8px">
            <input type="text" id="rh-search-name" placeholder="Pr√©nom (ex: Alice)" />
            <button class="btn" id="rh-search">Voir disponibilit√©s</button>
          </div>
        </div>

        <div class="panel">
          <strong>Actions RH</strong>
          <div style="margin-top:8px">
              <label for="pdf-upload-input" class="small" style="margin-bottom:4px; display:block;">Ajouter un nouveau contrat :</label>
              <input type="file" id="pdf-upload-input" accept=".pdf" style="font-size: 0.85rem;">
              <button class="btn" id="pdf-upload-btn" style="margin-top:8px;">Envoyer PDF</button>
              <p class="small hidden" id="upload-status" style="margin-top:8px;"></p>
          </div>
          <hr style="border:0; border-top:1px solid var(--accent-border); margin: 14px 0;">
          <div class="choices">
              <button class="btn secondary" id="dl-csv">T√©l√©charger CSV</button>
          </div>
        </div>
      </div>

      <div id="rh-result" class="panel hidden" style="margin-top:14px">
        <h2 style="margin:0 0 10px 0">Disponibilit√©s de <span id="rh-emp-label" style="color:var(--accent)"></span></h2>
        <table id="rh-table">
          <thead>
            <tr><th>Jour</th><th>Plage de pr√©sence</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="rh-proposal" class="panel hidden" style="margin-top:14px; border-color:var(--success); background-color: #1a2a1f;">
        <h2 style="margin:0 0 10px 0; color:var(--success);">‚úÖ Proposition de planning g√©n√©r√©e</h2>
        <p class="small" id="proposal-message">L'employ√© a √©t√© ajout√©.</p>
        <table id="proposal-table" style="background: var(--card); border-radius: 8px;">
          <thead>
            <tr><th>Date</th><th>T√¢che (ID)</th><th>Plage</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn" id="btn-approve-plan" style="margin-top:12px; background-color: var(--success);">Approuver et appliquer ce plan</button>
        <p class="small hidden" id="approve-status" style="margin-top:8px;"></p>
      </div>
    </div>

    <div class="card hidden" id="screen-emp">
      <div class="topbar">
        <h1>Mon planning</h1>
        <button class="btn secondary" id="emp-back">Quitter</button>
      </div>
      <div class="grid">
        <div class="panel">
          <div><strong>Pr√©nom :</strong> <span id="emp-firstname"></span></div>
          <div><strong>Poste :</strong> <span id="emp-role"></span></div>
        </div>
      </div>
      <h2 style="margin-top:14px">Mes t√¢ches planifi√©es</h2>
      <table id="emp-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>T√¢che</th>
            <th>Horaires</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small hidden" id="emp-no-tasks">Aucune t√¢che n'est planifi√©e pour toi pour l'instant.</p>
    </div>
  </div> <button id="chat-toggle" class="fab-chat hidden" title="Ouvrir le chat">üí¨</button>
  <div id="chat-widget" class="chat chat-closed">
    <div class="chat-header">
      <div><strong id="chat-title">Assistant</strong><div class="small" id="chat-subtitle">Support planning</div></div>
      <button id="chat-close" class="link-like">‚úï</button>
    </div>
    <div id="chat-body" class="chat-body"></div>
    <form id="chat-form" class="chat-input" autocomplete="off">
      <input id="chat-text" type="text" placeholder="√âcrire un message‚Ä¶" />
      <button class="btn" type="submit">Envoyer</button>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function() {
      // =========================================
      // 1. CONFIGURATION
      // =========================================
      const API_PLANNING_URL = "http://localhost:5000/api/planning";
      const API_SCHEDULE_URL = "http://localhost:5000/api/my-schedule";
      const API_UPLOAD_URL = "http://localhost:5000/api/upload-contract";
      const API_APPROVE_URL = "http://localhost:5000/api/approve-plan";
      const API_CHAT_URL = "http://localhost:5000/api/chat";
      const API_PENDING_ABSENCES_URL = "http://localhost:5000/api/pending-absences";
      const API_REVIEW_ABSENCE_URL = "http://localhost:5000/api/review-absence";
      const RH_CODE = "RH2025";
      const DAYS_ORDER = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];
      const DAYS_MAP = {'Mon': 'Lun', 'Tue': 'Mar', 'Wed': 'Mer', 'Thu': 'Jeu', 'Fri': 'Ven', 'Sat': 'Sam', 'Sun': 'Dim'};

      let employeesData = [];
      let index = {};
      const norm = (v) => (v || "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      // Variables d'√©tat
      let currentRole = null;
      let currentEmployee = null;
      let currentProposal = null;
      
      // =========================================
      // 2. S√âLECTION DES √âL√âMENTS (DOM)
      // =========================================
      const $ = (sel) => document.querySelector(sel);
      
      // Panneaux RH
      const absencesTbody = $("#absences-table-body");
      const noAbsencesMsg = $("#absences-none");
      const uploadInput = $("#pdf-upload-input");
      const uploadBtn = $("#pdf-upload-btn");
      const uploadStatus = $("#upload-status");
      const proposalPanel = $("#rh-proposal");
      const proposalMsg = $("#proposal-message");
      const proposalTableBody = document.querySelector("#proposal-table tbody");
      const approveBtn = $("#btn-approve-plan");
      const approveStatus = $("#approve-status");
      
      // Panneaux Employ√©
      const empTableTbody = document.querySelector("#emp-table tbody");
      const noTasksMsg = $("#emp-no-tasks");

      // Chat
      const chatBox = $("#chat-widget");
      const chatBtn = $("#chat-toggle");
      const chatBody = $("#chat-body");
      const chatInput = $("#chat-text");
      const chatTitle = $("#chat-title");
      const chatSub = $("#chat-subtitle");

      // =========================================
      // 3. FONCTIONS UTILITAIRES
      // =========================================
      const show = (id) => document.getElementById(id).classList.remove("hidden");
      const hide = (id) => document.getElementById(id).classList.add("hidden");

      function fillDispoTable(tbody, week) {
        tbody.innerHTML = "";
        DAYS_ORDER.forEach((d) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${d}</td><td>${week[d] || "‚Äî"}</td>`;
          if(!week[d]) tr.lastChild.style.color = "var(--muted)";
          tbody.appendChild(tr);
        });
      }

      function fillScheduleTable(tbody, schedule) {
          tbody.innerHTML = "";
          if (schedule.length === 0) { show("emp-no-tasks"); return; }
          hide("emp-no-tasks");
          schedule.forEach(item => {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${item.date}</td><td>${item.task}</td><td>${item.start}‚Äì${item.end}</td>`;
              tbody.appendChild(tr);
          });
      }

      function updateChatRole() {
        chatBody.innerHTML = "";
        chatTitle.textContent = currentRole === "emp" ? "Assistant RH" : "Assistant Admin";
        chatSub.textContent = currentRole === "emp" ? "D√©clare une absence" : "Gestion";
      }

      function addMsg(who, text) {
        const d = document.createElement("div"); d.className = "msg " + (who==="user"?"from-user":"from-bot");
        d.innerHTML = `<div class="bubble">${text}</div>`; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight;
      }
      
      function maybeGreet() {
        if (chatBody.children.length === 0) {
            const msg = currentRole === 'emp' 
              ? `Bonjour ${currentEmployee.name} ! Tu peux me demander un cong√© (ex: 'je pose des cong√©s lundi prochain') ou d√©clarer une absence (ex: 'je suis malade demain').` 
              : "Bonjour ! Le chat RH est en cours de d√©veloppement.";
            addMsg("bot", msg);
        }
      }

      // =========================================
      // 4. CHARGEMENT INITIAL DES DONN√âES
      // =========================================
      async function loadData() {
        try {
          const response = await fetch(API_PLANNING_URL);
          if (!response.ok) throw new Error("Erreur connexion serveur");
          const rawData = await response.json();
          if (rawData.error) throw new Error(`Erreur serveur: ${rawData.error}`);

          const tempMap = {};
          rawData.forEach(row => {
              const fullName = row.first_name;
              if (!tempMap[fullName]) {
                  tempMap[fullName] = { name: fullName, role: row.role || "Employ√©", week: {} };
              }
              if (row.day) {
                const dayFr = DAYS_MAP[row.day] || row.day;
                const start = row.start ? row.start.substring(0, 5) : "";
                const end = row.end ? row.end.substring(0, 5) : "";
                tempMap[fullName].week[dayFr] = `${start}‚Äì${end}`;
              }
          });

          employeesData = Object.values(tempMap);
          index = {};
          employeesData.forEach(e => { index[norm(e.name)] = e; });
          console.log("‚úÖ Donn√©es (disponibilit√©s) charg√©es depuis la DB :", employeesData);
          return true;

        } catch (error) {
          console.error("Erreur API:", error);
          alert("Impossible de connecter au serveur (server.py). V√©rifie qu'il est lanc√© !");
          employeesData = [];
          return false;
        }
      }
      
      const loaded = await loadData();
      if (!loaded) { hide("form-rh"); hide("form-emp"); }
      
      // =========================================
      // 5. √âCOUTEURS D'√âV√âNEMENTS (Main)
      // =========================================
      
      // --- Navigation Accueil ---
      $("#btn-rh").onclick = () => { if(loaded) { show("form-rh"); hide("form-emp"); $("#rh-code").focus(); }};
      $("#btn-emp").onclick = () => { if(loaded) { show("form-emp"); hide("form-rh"); $("#emp-name").focus(); }};

      // --- LOGIN RH ---
      function loginRH() {
        if ($("#rh-code").value.trim() === RH_CODE) {
          $("#rh-code").value = "";
          hide("screen-home"); show("screen-rh");
          currentRole = "rh"; 
          updateChatRole(); // Appel corrig√©
          show("chat-toggle");
          loadAndDisplayAbsences();
        } else { alert("Code incorrect (RH2025)"); }
      }
      $("#rh-validate").onclick = loginRH;
      $("#rh-code").addEventListener("keyup", (e) => { if (e.key === "Enter") loginRH(); });

      // --- GESTION DES ABSENCES RH ---
      async function loadAndDisplayAbsences() {
          try {
              const response = await fetch(API_PENDING_ABSENCES_URL);
              if (!response.ok) throw new Error("Impossible de charger les absences");
              const absences = await response.json();
              
              absencesTbody.innerHTML = "";
              if (absences.length === 0) { show("absences-none"); return; }
              hide("absences-none");
              
              absences.forEach(abs => {
                  const tr = document.createElement("tr");
                  tr.id = `absence-row-${abs.id}`;
                  tr.innerHTML = `
                      <td>${abs.employee_name}</td>
                      <td>${abs.start_date} au ${abs.end_date}</td>
                      <td>${abs.reason}</td>
                      <td>
                          <button class="btn btn-approve" data-id="${abs.id}" style="padding: 4px 8px; font-size: 0.8rem; background-color: var(--success);">‚úî</button>
                          <button class="btn btn-reject" data-id="${abs.id}" style="padding: 4px 8px; font-size: 0.8rem; background-color: var(--danger);">‚úñ</button>
                      </td>
                  `;
                  absencesTbody.appendChild(tr);
              });

              absencesTbody.querySelectorAll(".btn-approve").forEach(btn => {
                  btn.onclick = () => handleReview(btn.dataset.id, "Approved");
              });
              absencesTbody.querySelectorAll(".btn-reject").forEach(btn => {
                  btn.onclick = () => handleReview(btn.dataset.id, "Rejected");
              });
          } catch (error) {
              absencesTbody.innerHTML = `<tr><td colspan="4" style="color:var(--danger)">${error.message}</td></tr>`;
          }
      }
      
      async function handleReview(absenceId, newStatus) {
          try {
              const response = await fetch(API_REVIEW_ABSENCE_URL, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ absence_id: parseInt(absenceId, 10), new_status: newStatus })
              });
              const result = await response.json();
              if (!response.ok) throw new Error(result.error);

              const rowToRemove = $(`#absence-row-${absenceId}`);
              if (rowToRemove) rowToRemove.remove();
              if (absencesTbody.children.length === 0) { show("absences-none"); }
          } catch (error) {
              alert(`Erreur lors de la mise √† jour: ${error.message}`);
          }
      }

      // --- AUTRES ACTIONS RH ---
      $("#btn-rh-back").onclick = () => {
        hide("screen-rh"); show("screen-home"); currentRole = null; hide("chat-toggle"); hide("rh-result"); $("#rh-search-name").value="";
      };
      
      function searchEmployee() {
        const query = $("#rh-search-name").value;
        const emp = index[norm(query)];
        const tbody = document.querySelector("#rh-table tbody");
        if (emp) {
          $("#rh-emp-label").textContent = emp.name + " (" + emp.role + ")";
          fillDispoTable(tbody, emp.week);
          show("rh-result");
        } else { alert("Employ√© introuvable."); }
      }
      $("#rh-search").onclick = searchEmployee;
      $("#rh-search-name").addEventListener("keyup", (e) => { if (e.key === "Enter") searchEmployee(); });

      $("#dl-csv").onclick = () => { /* ... (code inchang√©) ... */ };
      
      uploadBtn.onclick = async () => {
          const file = uploadInput.files[0];
          if (!file || file.type !== "application/pdf") {
              alert("Veuillez s√©lectionner un fichier PDF."); return;
          }
          const formData = new FormData();
          formData.append("file", file);

          uploadStatus.textContent = "T√©l√©chargement et analyse IA en cours... (peut prendre 30 sec)";
          uploadStatus.classList.remove("hidden");
          uploadStatus.style.color = "var(--muted)";
          proposalPanel.classList.add("hidden");
          approveStatus.classList.add("hidden");
          uploadBtn.disabled = true;

          try {
              const response = await fetch(API_UPLOAD_URL, { method: "POST", body: formData });
              const result = await response.json();
              if (!response.ok) throw new Error(result.error || "Erreur inconnue");
              
              uploadStatus.textContent = result.message;
              uploadInput.value = "";
              
              await loadData(); // Recharger les donn√©es

              if (result.plan_proposal && result.plan_proposal.plan.length > 0) {
                  currentProposal = result.plan_proposal;
                  proposalTableBody.innerHTML = "";
                  result.plan_proposal.plan.forEach(item => {
                      const tr = document.createElement("tr");
                      tr.innerHTML = `
                          <td>${item.date}</td>
                          <td>T√¢che #${item.task_id}</td>
                          <td>${item.start_time} - ${item.end_time}</td>
                      `;
                      proposalTableBody.appendChild(tr);
                  });
                  proposalMsg.textContent = result.message;
                  proposalPanel.classList.remove("hidden");
                  approveStatus.textContent = "";
                  approveStatus.classList.add("hidden");
                  uploadStatus.style.color = "var(--success)";
              } else if (result.report && result.report.errors.length > 0) {
                   uploadStatus.textContent = `Employ√© ajout√©, mais le plan a √©chou√©: ${result.report.errors[0]}`;
                   uploadStatus.style.color = "var(--danger)";
              } else {
                   uploadStatus.textContent = "Employ√© ajout√©. Aucune t√¢che n'a pu √™tre planifi√©e (v√©rifiez les t√¢ches 'Pending').";
                   uploadStatus.style.color = "var(--muted)";
              }
          } catch (error) {
              uploadStatus.textContent = `Erreur: ${error.message}`;
              uploadStatus.style.color = "var(--danger)";
          } finally {
              uploadBtn.disabled = false;
          }
      };

      // --- √âCOUTEUR D'APPROBATION ---
      approveBtn.onclick = async () => {
          if (!currentProposal) return;
          
          approveStatus.textContent = "Application en cours...";
          approveStatus.classList.remove("hidden");
          approveStatus.style.color = "var(--muted)";
          approveBtn.disabled = true;
          
          try {
              const response = await fetch(API_APPROVE_URL, {
                  method: "POST",
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(currentProposal)
              });
              
              const result = await response.json();
              if (!response.ok) throw new Error(result.error);
              
              approveStatus.textContent = result.message;
              approveStatus.style.color = "var(--success)";
              currentProposal = null;
              setTimeout(() => { proposalPanel.classList.add("hidden"); }, 2000);

          } catch (error) {
              approveStatus.textContent = `Erreur: ${error.message}`;
              approveStatus.style.color = "var(--danger)";
          } finally {
              approveBtn.disabled = false;
          }
      };


      // --- LOGIN EMP ---
      async function loginEmp() {
        const name = $("#emp-name").value;
        const emp = index[norm(name)];
        if (!emp) { alert("Pr√©nom introuvable."); return; }
        currentEmployee = emp;
        $("#emp-firstname").textContent = emp.name;
        $("#emp-role").textContent = emp.role;
        try {
            const response = await fetch(`${API_SCHEDULE_URL}?name=${encodeURIComponent(emp.name)}`);
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Erreur r√©cup√©ration planning.");
            }
            const scheduleData = await response.json();
            fillScheduleTable(empTableTbody, scheduleData); // Corrig√©
            $("#emp-name").value = ""; 
            hide("screen-home"); show("screen-emp");
            currentRole = "emp"; 
            updateChatRole(); // Corrig√©
            show("chat-toggle");
        } catch (error) {
            console.error(error); alert(error.message);
        }
      }
      $("#emp-open").onclick = loginEmp;
      $("#emp-name").addEventListener("keyup", (e) => { if (e.key === "Enter") loginEmp(); });
      $("#emp-back").onclick = () => { hide("screen-emp"); show("screen-home"); currentRole = null; hide("chat-toggle"); };

      // --- CHAT ---
      chatBtn.onclick = () => { chatBox.classList.toggle("chat-closed"); if(!chatBox.classList.contains("chat-closed")) { chatInput.focus(); maybeGreet(); }};
      $("#chat-close").onclick = () => chatBox.classList.add("chat-closed");

      $("#chat-form").addEventListener("submit", async (e) => {
        e.preventDefault(); 
        const text = chatInput.value.trim(); 
        if(!text) return;
        addMsg("user", text);
        chatInput.value = "";
        addMsg("bot", "...");
        
        if (currentRole === 'emp') {
            try {
                const response = await fetch(API_CHAT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: text,
                        employee_name: currentEmployee.name 
                    })
                });
                const data = await response.json();
                chatBody.removeChild(chatBody.lastChild);
                if (data.error) { addMsg("bot", `Erreur: ${data.error}`); } 
                else { addMsg("bot", data.reply); }
            } catch (err) {
                chatBody.removeChild(chatBody.lastChild);
                addMsg("bot", "D√©sol√©, une erreur de connexion est survenue.");
                console.error(err);
            }
        } else {
            setTimeout(() => {
                chatBody.removeChild(chatBody.lastChild);
                addMsg("bot", "Le chat pour les RH est en cours de d√©veloppement.");
            }, 600);
        }
      });
      // --- FIN DU CHAT ---

    }); // <-- FIN DU 'DOMContentLoaded'
  </script>
</body>
</html><!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acc√®s Planning ‚Äî RH / Employ√©</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="force-dark">
  <div class="wrap">
    <div class="card" id="screen-home">
      <h1>Acc√®s au planning</h1>
      <p class="lead">Connexion √† la base de donn√©es en direct.</p>

      <div class="choices">
        <button class="btn" id="btn-rh">Je suis RH</button>
        <button class="btn secondary" id="btn-emp">Je suis un¬∑e employ√©¬∑e</button>
      </div>

      <div id="form-rh" class="panel hidden fade-in">
        <div class="input-row">
          <input type="password" id="rh-code" placeholder="Code RH (Essaye: RH2025)" />
          <button class="btn" id="rh-validate">Valider</button>
        </div>
        <p class="small">Le code par d√©faut est <strong>RH2025</strong>.</p>
      </div>

      <div id="form-emp" class="panel hidden fade-in">
        <div class="input-row">
          <input type="text" id="emp-name" placeholder="Pr√©nom (ex. Alice)" autocomplete="name" />
          <button class="btn" id="emp-open">Entrer</button>
        </div>
        <p class="small">Saisis ton pr√©nom pour ouvrir ta page personnelle.</p>
      </div>
    </div>

    <div class="card hidden" id="screen-rh">
      <div class="topbar">
        <h1>Tableau de bord RH</h1>
        <div>
          <button class="btn secondary" id="btn-rh-back">D√©connexion</button>
        </div>
      </div>

      <div id="rh-absences-panel" class="panel" style="border-color: var(--danger); background-color: #2a1919;">
        <h2 style="margin:0 0 10px 0; color:var(--danger);">Demandes d'absence en attente</h2>
        <table id="absences-table" style="background: var(--card); border-radius: 8px;">
          <thead>
            <tr><th>Employ√©</th><th>Dates</th><th>Motif</th><th>Actions</th></tr>
          </thead>
          <tbody id="absences-table-body"></tbody>
        </table>
        <p class="small hidden" id="absences-none">Aucune demande d'absence en attente.</p>
      </div>
      <div class="grid" style="margin-top: 14px;">
        <div class="panel">
          <strong>Rechercher un¬∑e employ√©¬∑e</strong>
          <div class="input-row" style="margin-top:8px">
            <input type="text" id="rh-search-name" placeholder="Pr√©nom (ex: Alice)" />
            <button class="btn" id="rh-search">Voir disponibilit√©s</button>
          </div>
        </div>

        <div class="panel">
          <strong>Actions RH</strong>
          <div style="margin-top:8px">
              <label for="pdf-upload-input" class="small" style="margin-bottom:4px; display:block;">Ajouter un nouveau contrat :</label>
              <input type="file" id="pdf-upload-input" accept=".pdf" style="font-size: 0.85rem;">
              <button class="btn" id="pdf-upload-btn" style="margin-top:8px;">Envoyer PDF</button>
              <p class="small hidden" id="upload-status" style="margin-top:8px;"></p>
          </div>
          <hr style="border:0; border-top:1px solid var(--accent-border); margin: 14px 0;">
          <div class="choices">
              <button class="btn secondary" id="dl-csv">T√©l√©charger CSV</button>
          </div>
        </div>
      </div>

      <div id="rh-result" class="panel hidden" style="margin-top:14px">
        <h2 style="margin:0 0 10px 0">Disponibilit√©s de <span id="rh-emp-label" style="color:var(--accent)"></span></h2>
        <table id="rh-table">
          <thead>
            <tr><th>Jour</th><th>Plage de pr√©sence</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="rh-proposal" class="panel hidden" style="margin-top:14px; border-color:var(--success); background-color: #1a2a1f;">
        <h2 style="margin:0 0 10px 0; color:var(--success);">‚úÖ Proposition de planning g√©n√©r√©e</h2>
        <p class="small" id="proposal-message">L'employ√© a √©t√© ajout√©.</p>
        <table id="proposal-table" style="background: var(--card); border-radius: 8px;">
          <thead>
            <tr><th>Date</th><th>T√¢che (ID)</th><th>Plage</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn" id="btn-approve-plan" style="margin-top:12px; background-color: var(--success);">Approuver et appliquer ce plan</button>
        <p class="small hidden" id="approve-status" style="margin-top:8px;"></p>
      </div>
    </div>

    <div class="card hidden" id="screen-emp">
      <div class="topbar">
        <h1>Mon planning</h1>
        <button class="btn secondary" id="emp-back">Quitter</button>
      </div>
      <div class="grid">
        <div class="panel">
          <div><strong>Pr√©nom :</strong> <span id="emp-firstname"></span></div>
          <div><strong>Poste :</strong> <span id="emp-role"></span></div>
        </div>
      </div>
      <h2 style="margin-top:14px">Mes t√¢ches planifi√©es</h2>
      <table id="emp-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>T√¢che</th>
            <th>Horaires</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="small hidden" id="emp-no-tasks">Aucune t√¢che n'est planifi√©e pour toi pour l'instant.</p>
    </div>
  </div> <button id="chat-toggle" class="fab-chat hidden" title="Ouvrir le chat">üí¨</button>
  <div id="chat-widget" class="chat chat-closed">
    <div class="chat-header">
      <div><strong id="chat-title">Assistant</strong><div class="small" id="chat-subtitle">Support planning</div></div>
      <button id="chat-close" class="link-like">‚úï</button>
    </div>
    <div id="chat-body" class="chat-body"></div>
    <form id="chat-form" class="chat-input" autocomplete="off">
      <input id="chat-text" type="text" placeholder="√âcrire un message‚Ä¶" />
      <button class="btn" type="submit">Envoyer</button>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function() {
      // =========================================
      // 1. CONFIGURATION
      // =========================================
      const API_PLANNING_URL = "http://localhost:5000/api/planning";
      const API_SCHEDULE_URL = "http://localhost:5000/api/my-schedule";
      const API_UPLOAD_URL = "http://localhost:5000/api/upload-contract";
      const API_APPROVE_URL = "http://localhost:5000/api/approve-plan";
      const API_CHAT_URL = "http://localhost:5000/api/chat";
      const API_PENDING_ABSENCES_URL = "http://localhost:5000/api/pending-absences";
      const API_REVIEW_ABSENCE_URL = "http://localhost:5000/api/review-absence";
      const RH_CODE = "RH2025";
      const DAYS_ORDER = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"];
      const DAYS_MAP = {'Mon': 'Lun', 'Tue': 'Mar', 'Wed': 'Mer', 'Thu': 'Jeu', 'Fri': 'Ven', 'Sat': 'Sam', 'Sun': 'Dim'};

      let employeesData = [];
      let index = {};
      const norm = (v) => (v || "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      // Variables d'√©tat
      let currentRole = null;
      let currentEmployee = null;
      let currentProposal = null;
      
      // =========================================
      // 2. S√âLECTION DES √âL√âMENTS (DOM)
      // =========================================
      const $ = (sel) => document.querySelector(sel);
      
      // Panneaux RH
      const absencesTbody = $("#absences-table-body");
      const noAbsencesMsg = $("#absences-none");
      const uploadInput = $("#pdf-upload-input");
      const uploadBtn = $("#pdf-upload-btn");
      const uploadStatus = $("#upload-status");
      const proposalPanel = $("#rh-proposal");
      const proposalMsg = $("#proposal-message");
      const proposalTableBody = document.querySelector("#proposal-table tbody");
      const approveBtn = $("#btn-approve-plan");
      const approveStatus = $("#approve-status");
      
      // Panneaux Employ√©
      const empTableTbody = document.querySelector("#emp-table tbody");
      const noTasksMsg = $("#emp-no-tasks");

      // Chat
      const chatBox = $("#chat-widget");
      const chatBtn = $("#chat-toggle");
      const chatBody = $("#chat-body");
      const chatInput = $("#chat-text");
      const chatTitle = $("#chat-title");
      const chatSub = $("#chat-subtitle");

      // =========================================
      // 3. FONCTIONS UTILITAIRES
      // =========================================
      const show = (id) => document.getElementById(id).classList.remove("hidden");
      const hide = (id) => document.getElementById(id).classList.add("hidden");

      function fillDispoTable(tbody, week) {
        tbody.innerHTML = "";
        DAYS_ORDER.forEach((d) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${d}</td><td>${week[d] || "‚Äî"}</td>`;
          if(!week[d]) tr.lastChild.style.color = "var(--muted)";
          tbody.appendChild(tr);
        });
      }

      function fillScheduleTable(tbody, schedule) {
          tbody.innerHTML = "";
          if (schedule.length === 0) { show("emp-no-tasks"); return; }
          hide("emp-no-tasks");
          schedule.forEach(item => {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${item.date}</td><td>${item.task}</td><td>${item.start}‚Äì${item.end}</td>`;
              tbody.appendChild(tr);
          });
      }

      function updateChatRole() {
        chatBody.innerHTML = "";
        chatTitle.textContent = currentRole === "emp" ? "Assistant RH" : "Assistant Admin";
        chatSub.textContent = currentRole === "emp" ? "D√©clare une absence" : "Gestion";
      }

      function addMsg(who, text) {
        const d = document.createElement("div"); d.className = "msg " + (who==="user"?"from-user":"from-bot");
        d.innerHTML = `<div class="bubble">${text}</div>`; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight;
      }
      
      function maybeGreet() {
        if (chatBody.children.length === 0) {
            const msg = currentRole === 'emp' 
              ? `Bonjour ${currentEmployee.name} ! Tu peux me demander un cong√© (ex: 'je pose des cong√©s lundi prochain') ou d√©clarer une absence (ex: 'je suis malade demain').` 
              : "Bonjour ! Le chat RH est en cours de d√©veloppement.";
            addMsg("bot", msg);
        }
      }

      // =========================================
      // 4. CHARGEMENT INITIAL DES DONN√âES
      // =========================================
      async function loadData() {
        try {
          const response = await fetch(API_PLANNING_URL);
          if (!response.ok) throw new Error("Erreur connexion serveur");
          const rawData = await response.json();
          if (rawData.error) throw new Error(`Erreur serveur: ${rawData.error}`);

          const tempMap = {};
          rawData.forEach(row => {
              const fullName = row.first_name;
              if (!tempMap[fullName]) {
                  tempMap[fullName] = { name: fullName, role: row.role || "Employ√©", week: {} };
              }
              if (row.day) {
                const dayFr = DAYS_MAP[row.day] || row.day;
                const start = row.start ? row.start.substring(0, 5) : "";
                const end = row.end ? row.end.substring(0, 5) : "";
                tempMap[fullName].week[dayFr] = `${start}‚Äì${end}`;
              }
          });

          employeesData = Object.values(tempMap);
          index = {};
          employeesData.forEach(e => { index[norm(e.name)] = e; });
          console.log("‚úÖ Donn√©es (disponibilit√©s) charg√©es depuis la DB :", employeesData);
          return true;

        } catch (error) {
          console.error("Erreur API:", error);
          alert("Impossible de connecter au serveur (server.py). V√©rifie qu'il est lanc√© !");
          employeesData = [];
          return false;
        }
      }
      
      const loaded = await loadData();
      if (!loaded) { hide("form-rh"); hide("form-emp"); }
      
      // =========================================
      // 5. √âCOUTEURS D'√âV√âNEMENTS (Main)
      // =========================================
      
      // --- Navigation Accueil ---
      $("#btn-rh").onclick = () => { if(loaded) { show("form-rh"); hide("form-emp"); $("#rh-code").focus(); }};
      $("#btn-emp").onclick = () => { if(loaded) { show("form-emp"); hide("form-rh"); $("#emp-name").focus(); }};

      // --- LOGIN RH ---
      function loginRH() {
        if ($("#rh-code").value.trim() === RH_CODE) {
          $("#rh-code").value = "";
          hide("screen-home"); show("screen-rh");
          currentRole = "rh"; 
          updateChatRole(); // Appel corrig√©
          show("chat-toggle");
          loadAndDisplayAbsences();
        } else { alert("Code incorrect (RH2025)"); }
      }
      $("#rh-validate").onclick = loginRH;
      $("#rh-code").addEventListener("keyup", (e) => { if (e.key === "Enter") loginRH(); });

      // --- GESTION DES ABSENCES RH ---
      async function loadAndDisplayAbsences() {
          try {
              const response = await fetch(API_PENDING_ABSENCES_URL);
              if (!response.ok) throw new Error("Impossible de charger les absences");
              const absences = await response.json();
              
              absencesTbody.innerHTML = "";
              if (absences.length === 0) { show("absences-none"); return; }
              hide("absences-none");
              
              absences.forEach(abs => {
                  const tr = document.createElement("tr");
                  tr.id = `absence-row-${abs.id}`;
                  tr.innerHTML = `
                      <td>${abs.employee_name}</td>
                      <td>${abs.start_date} au ${abs.end_date}</td>
                      <td>${abs.reason}</td>
                      <td>
                          <button class="btn btn-approve" data-id="${abs.id}" style="padding: 4px 8px; font-size: 0.8rem; background-color: var(--success);">‚úî</button>
                          <button class="btn btn-reject" data-id="${abs.id}" style="padding: 4px 8px; font-size: 0.8rem; background-color: var(--danger);">‚úñ</button>
                      </td>
                  `;
                  absencesTbody.appendChild(tr);
              });

              absencesTbody.querySelectorAll(".btn-approve").forEach(btn => {
                  btn.onclick = () => handleReview(btn.dataset.id, "Approved");
              });
              absencesTbody.querySelectorAll(".btn-reject").forEach(btn => {
                  btn.onclick = () => handleReview(btn.dataset.id, "Rejected");
              });
          } catch (error) {
              absencesTbody.innerHTML = `<tr><td colspan="4" style="color:var(--danger)">${error.message}</td></tr>`;
          }
      }
      
      async function handleReview(absenceId, newStatus) {
          try {
              const response = await fetch(API_REVIEW_ABSENCE_URL, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ absence_id: parseInt(absenceId, 10), new_status: newStatus })
              });
              const result = await response.json();
              if (!response.ok) throw new Error(result.error);

              const rowToRemove = $(`#absence-row-${absenceId}`);
              if (rowToRemove) rowToRemove.remove();
              if (absencesTbody.children.length === 0) { show("absences-none"); }
          } catch (error) {
              alert(`Erreur lors de la mise √† jour: ${error.message}`);
          }
      }

      // --- AUTRES ACTIONS RH ---
      $("#btn-rh-back").onclick = () => {
        hide("screen-rh"); show("screen-home"); currentRole = null; hide("chat-toggle"); hide("rh-result"); $("#rh-search-name").value="";
      };
      
      function searchEmployee() {
        const query = $("#rh-search-name").value;
        const emp = index[norm(query)];
        const tbody = document.querySelector("#rh-table tbody");
        if (emp) {
          $("#rh-emp-label").textContent = emp.name + " (" + emp.role + ")";
          fillDispoTable(tbody, emp.week);
          show("rh-result");
        } else { alert("Employ√© introuvable."); }
      }
      $("#rh-search").onclick = searchEmployee;
      $("#rh-search-name").addEventListener("keyup", (e) => { if (e.key === "Enter") searchEmployee(); });

      $("#dl-csv").onclick = () => { /* ... (code inchang√©) ... */ };
      
      uploadBtn.onclick = async () => {
          const file = uploadInput.files[0];
          if (!file || file.type !== "application/pdf") {
              alert("Veuillez s√©lectionner un fichier PDF."); return;
          }
          const formData = new FormData();
          formData.append("file", file);

          uploadStatus.textContent = "T√©l√©chargement et analyse IA en cours... (peut prendre 30 sec)";
          uploadStatus.classList.remove("hidden");
          uploadStatus.style.color = "var(--muted)";
          proposalPanel.classList.add("hidden");
          approveStatus.classList.add("hidden");
          uploadBtn.disabled = true;

          try {
              const response = await fetch(API_UPLOAD_URL, { method: "POST", body: formData });
              const result = await response.json();
              if (!response.ok) throw new Error(result.error || "Erreur inconnue");
              
              uploadStatus.textContent = result.message;
              uploadInput.value = "";
              
              await loadData(); // Recharger les donn√©es

              if (result.plan_proposal && result.plan_proposal.plan.length > 0) {
                  currentProposal = result.plan_proposal;
                  proposalTableBody.innerHTML = "";
                  result.plan_proposal.plan.forEach(item => {
                      const tr = document.createElement("tr");
                      tr.innerHTML = `
                          <td>${item.date}</td>
                          <td>T√¢che #${item.task_id}</td>
                          <td>${item.start_time} - ${item.end_time}</td>
                      `;
                      proposalTableBody.appendChild(tr);
                  });
                  proposalMsg.textContent = result.message;
                  proposalPanel.classList.remove("hidden");
                  approveStatus.textContent = "";
                  approveStatus.classList.add("hidden");
                  uploadStatus.style.color = "var(--success)";
              } else if (result.report && result.report.errors.length > 0) {
                   uploadStatus.textContent = `Employ√© ajout√©, mais le plan a √©chou√©: ${result.report.errors[0]}`;
                   uploadStatus.style.color = "var(--danger)";
              } else {
                   uploadStatus.textContent = "Employ√© ajout√©. Aucune t√¢che n'a pu √™tre planifi√©e (v√©rifiez les t√¢ches 'Pending').";
                   uploadStatus.style.color = "var(--muted)";
              }
          } catch (error) {
              uploadStatus.textContent = `Erreur: ${error.message}`;
              uploadStatus.style.color = "var(--danger)";
          } finally {
              uploadBtn.disabled = false;
          }
      };

      // --- √âCOUTEUR D'APPROBATION ---
      approveBtn.onclick = async () => {
          if (!currentProposal) return;
          
          approveStatus.textContent = "Application en cours...";
          approveStatus.classList.remove("hidden");
          approveStatus.style.color = "var(--muted)";
          approveBtn.disabled = true;
          
          try {
              const response = await fetch(API_APPROVE_URL, {
                  method: "POST",
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(currentProposal)
              });
              
              const result = await response.json();
              if (!response.ok) throw new Error(result.error);
              
              approveStatus.textContent = result.message;
              approveStatus.style.color = "var(--success)";
              currentProposal = null;
              setTimeout(() => { proposalPanel.classList.add("hidden"); }, 2000);

          } catch (error) {
              approveStatus.textContent = `Erreur: ${error.message}`;
              approveStatus.style.color = "var(--danger)";
          } finally {
              approveBtn.disabled = false;
          }
      };


      // --- LOGIN EMP ---
      async function loginEmp() {
        const name = $("#emp-name").value;
        const emp = index[norm(name)];
        if (!emp) { alert("Pr√©nom introuvable."); return; }
        currentEmployee = emp;
        $("#emp-firstname").textContent = emp.name;
        $("#emp-role").textContent = emp.role;
        try {
            const response = await fetch(`${API_SCHEDULE_URL}?name=${encodeURIComponent(emp.name)}`);
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Erreur r√©cup√©ration planning.");
            }
            const scheduleData = await response.json();
            fillScheduleTable(empTableTbody, scheduleData); // Corrig√©
            $("#emp-name").value = ""; 
            hide("screen-home"); show("screen-emp");
            currentRole = "emp"; 
            updateChatRole(); // Corrig√©
            show("chat-toggle");
        } catch (error) {
            console.error(error); alert(error.message);
        }
      }
      $("#emp-open").onclick = loginEmp;
      $("#emp-name").addEventListener("keyup", (e) => { if (e.key === "Enter") loginEmp(); });
      $("#emp-back").onclick = () => { hide("screen-emp"); show("screen-home"); currentRole = null; hide("chat-toggle"); };

      // --- CHAT ---
      chatBtn.onclick = () => { chatBox.classList.toggle("chat-closed"); if(!chatBox.classList.contains("chat-closed")) { chatInput.focus(); maybeGreet(); }};
      $("#chat-close").onclick = () => chatBox.classList.add("chat-closed");

      $("#chat-form").addEventListener("submit", async (e) => {
        e.preventDefault(); 
        const text = chatInput.value.trim(); 
        if(!text) return;
        addMsg("user", text);
        chatInput.value = "";
        addMsg("bot", "...");
        
        if (currentRole === 'emp') {
            try {
                const response = await fetch(API_CHAT_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: text,
                        employee_name: currentEmployee.name 
                    })
                });
                const data = await response.json();
                chatBody.removeChild(chatBody.lastChild);
                if (data.error) { addMsg("bot", `Erreur: ${data.error}`); } 
                else { addMsg("bot", data.reply); }
            } catch (err) {
                chatBody.removeChild(chatBody.lastChild);
                addMsg("bot", "D√©sol√©, une erreur de connexion est survenue.");
                console.error(err);
            }
        } else {
            setTimeout(() => {
                chatBody.removeChild(chatBody.lastChild);
                addMsg("bot", "Le chat pour les RH est en cours de d√©veloppement.");
            }, 600);
        }
      });
      // --- FIN DU CHAT ---

    }); // <-- FIN DU 'DOMContentLoaded'
  </script>
</body>
</html>